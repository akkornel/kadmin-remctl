#!/usr/bin/make -f

# Add hardening build flags.  We have to omit PIE because it breaks the Perl
# module build (and probably the other interpretors as well).
export DEB_BUILD_MAINT_OPTIONS = hardening=+bindnow,+pie

HEIMDAL = debian/kadmin-remctl-heimdal

CFLAGS = -g -Wall -DPASSWD_FILE=\\\"/afs/ir/service/etc/passwd.all\\\" \
	-DHOST=\\\"password-change.stanford.edu\\\"
ifneq (,$(filter noopt,$(DEB_BUILD_OPTIONS)))
    CFLAGS += -O0
else
    CFLAGS += -O2
endif

%:
	dh $@ --parallel

override_dh_auto_configure:
	dh_auto_configure -- CFLAGS="$(CFLAGS)" --enable-reduced-depends

override_dh_auto_install:
	dh_auto_install
	install -d debian/kadmin-remctl/etc/remctl/reset
	install -m 644 remctl/password \
	    debian/kadmin-remctl/etc/remctl/reset/remctl.conf

override_dh_install:
	dh_install
	mv $(HEIMDAL)/usr/sbin/kadmin-backend-heim \
	    $(HEIMDAL)/usr/sbin/kadmin-backend
	mv $(HEIMDAL)/usr/share/man/man8/kadmin-backend-heim.8 \
	    $(HEIMDAL)/usr/share/man/man8/kadmin-backend.8
	perl -i -pe 's/KADMIN-BACKEND-HEIM/KADMIN-BACKEND/g' \
	    $(HEIMDAL)/usr/share/man/man8/kadmin-backend.8

override_dh_installchangelogs:
	dh_installchangelogs NEWS

override_dh_builddeb:
	dh_builddeb -- -Zxz
